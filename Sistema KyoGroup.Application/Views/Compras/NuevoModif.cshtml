@{
    ViewBag.Title = "Nueva / Editar Compra";
}
<title>@ViewBag.Title</title>

<partial name="~/Views/Utils/Modals.cshtml" />

@section Estilos {
    <link href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />

    <!-- SKIN general -->
    <link href="~/css/disenopantallas.css?v=1.0" rel="stylesheet" />
    <link href="~/css/OrdenesCompraNuevoModif.css" rel="stylesheet" />
    <link href="~/css/ComprasNuevoModif.css" rel="stylesheet" />

    <!-- Estilos específicos de Compras -->
   
}

<header class="cc-kpi cc-card cc-container-xxl">
    <div class="cc-kpi-icon"><i class="fa fa-shopping-cart"></i></div>
    <div class="cc-kpi-text">
        <h1 id="tituloCompra" class="cc-kpi-title">Nueva Compra</h1>
        <p class="cc-muted m-0">Orden de compra + detalle basado en la misma</p>
    </div>
    <button type="button" class="btn btn-outline-light ms-auto" onclick="window.location.href='/Compras'">
        <i class="fa fa-angle-left me-2"></i> Volver
    </button>
</header>

<main class="cc-container-xxl compras-wrapper">
    <!-- ==================== PASO 1: CABECERA ==================== -->
    <section class="cc-section cc-card compras-step">
        <div class="cc-titlebar">
            <h3 class="m-0"><i class="fa fa-info-circle me-2"></i>Orden de Compra</h3>
        </div>

        <input type="hidden" id="IdCompra" />
        <input type="hidden" id="IdUnidadNegocio" />
        <input type="hidden" id="IdLocal" />
        <input type="hidden" id="IdProveedor" />

        <div id="frmCabeceraCompra" class="cc-grid cc-grid-3xl compras-grid-cabecera">

                    <div class="form-group">
                <label class="form-label">Orden de Compra</label>
                <select id="OrdenCompraSelect" class="form-select" data-required="true">
                    <option value="" disabled selected>Seleccionar una Orden Pendiente...</option>
                </select>
                <div class="invalid-feedback d-none">Campo requerido</div>
                <small class="text-muted-cc">Solo se muestran órdenes en estado <strong>Pendiente</strong>.</small>
            </div>

            <div class="form-group">
                <label class="form-label">Unidad de Negocio</label>
                <input type="text" id="UnidadNegocioNombre" class="form-control compras-readonly" readonly placeholder="Seleccionar desde la OC..." />
                <div class="invalid-feedback d-none">Campo requerido</div>
            </div>

            <div class="form-group">
                <label class="form-label">Local</label>
                <input type="text" id="LocalNombre" class="form-control compras-readonly" readonly placeholder="Seleccionar desde la OC..." />
                <div class="invalid-feedback d-none">Campo requerido</div>
            </div>

            <div class="form-group">
                <label class="form-label">Proveedor</label>
                <input type="text" id="ProveedorNombre" class="form-control compras-readonly" readonly placeholder="Seleccionar desde la OC..." />
                <div class="invalid-feedback d-none">Campo requerido</div>
            </div>

            <div class="form-group">
                <label class="form-label">Fecha Compra</label>
                <input type="date" id="FechaCompra" class="form-control" data-required="true" />
                <div class="invalid-feedback d-none">Campo requerido</div>
            </div>

    

            <div class="form-group full">
                <label class="form-label">Nota Interna</label>
                <input type="text" id="NotaInterna" class="form-control" />
            </div>

            <div class="form-group">
                <label class="form-label">Subtotal</label>
                <input type="text" id="Subtotal" class="form-control compras-importes" readonly />
            </div>

            <div class="form-group">
                <label class="form-label">Descuentos</label>
                <input type="text" id="Descuentos" class="form-control compras-importes" value="0" />
            </div>

            <div class="form-group">
                <label class="form-label">Total Final</label>
                <input type="text" id="SubtotalFinal" class="form-control compras-importes compras-total-final" readonly />
            </div>
        </div>

        <div id="alertRequeridosCompra" class="cc-alert-inline d-none mt-3">
            <i class="fa fa-exclamation-triangle"></i> Debes completar los campos requeridos.
        </div>
    </section>

    <!-- ==================== PASO 2: DETALLE ==================== -->
    <section class="cc-section cc-card compras-step compras-detalle-wrapper">
        <div class="cc-titlebar">

            <h3 class="m-0"><i class="fa fa-cubes me-2"></i>Detalle de Insumos</h3>
            <span id="lblOrigenOC" class="compras-oc-badge d-none">
                Basado en OC <span id="lblNroOC"></span>
            </span>
        </div>

        <div class="cc-table compras-table-responsive">
            <table id="grd_DetalleCompra" class="table table-sm compras-detalle-table">
                <thead>
                    <tr>
                        <th class="col-insumo">INSUMO</th>
                        <th class="text-center">PEDIDA OC</th>
                        <th class="text-center">PENDIENTE OC</th>
                        <th class="text-center">RECIBIDA</th>
                        <th class="text-center">DIF. CANT</th>
                        <th class="text-center">PRECIO LISTA OC</th>
                        <th class="text-center">PRECIO FACTURA</th>
                        <th class="text-center">DIF. PRECIO</th>
                        <th class="text-center">ESTADO OC INSUMO</th>
                        <th class="text-center">SUBTOTAL</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- filas generadas por JS -->
                </tbody>
            </table>
        </div>

        <div id="alertDetalleCompra" class="cc-alert-inline d-none mt-3">
            <i class="fa fa-exclamation-triangle"></i> Debes agregar al menos un insumo con cantidad recibida mayor a 0.
        </div>
    </section>

    <div class="d-flex justify-content-end gap-2 my-3">
        <button type="button" id="btnNuevoModificarCompra" class="btn btn-new" onclick="guardarCompra()">
            <i class="fa fa-save me-1"></i> Registrar
        </button>
    </div>
</main>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

    <script src="~/js/cc.validators.js?v=1.0"></script>

    <script>
        var CompraData = @Html.Raw(Json.Serialize(ViewBag.Data ?? 0));   // si viene id de compra
        var IdOrdenCompraInicial = @Html.Raw(Json.Serialize(ViewBag.IdOrdenCompra ?? 0));
    </script>

    <script src="~/js/ComprasNuevoModif.js?v=1.0"></script>
    <script src="~/js/site.js"></script>

 
}
