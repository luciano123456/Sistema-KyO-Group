@{
    ViewBag.Title = "Nueva / Editar Orden de Compra";
}
<title>@ViewBag.Title</title>

<partial name="~/Views/Utils/Modals.cshtml" />

@section Estilos {
    <link href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />

    <!-- SKIN (igual al de Recetas) -->
    <link href="~/css/disenopantallas.css?v=1.0" rel="stylesheet" />
    <link href="~/css/OrdenesCompraNuevoModif.css" rel="stylesheet" />


}

<header class="cc-kpi cc-card cc-container-xxl">
    <div class="cc-kpi-icon"><i class="fa fa-shopping-basket"></i></div>
    <div class="cc-kpi-text">
        <h1 id="tituloOC" class="cc-kpi-title">Nueva Orden de Compra</h1>
        <p class="cc-muted m-0">Cabecera + Detalle de Insumos</p>
    </div>
    <button type="button" class="btn btn-outline-light ms-auto" onclick="window.location.href='/OrdenesCompras'">
        <i class="fa fa-angle-left me-2"></i> Volver
    </button>
</header>

<main class="cc-container-xxl">
    <!-- CABECERA -->
    <section class="cc-section cc-card">
        <div class="cc-titlebar">
            <h3 class="m-0"><i class="fa fa-info-circle me-2"></i>Orden de Compra</h3>
        </div>

        <input type="hidden" id="IdOC" />

        <!-- Form cabecera -->
        <div id="frmCabeceraOC" class="cc-grid cc-grid-3xl">
            <div class="form-group">
                <label class="form-label">Unidad de Negocio</label>
                <select id="UnidadesNegocio" class="form-select" data-required="true">
                    <option value="" disabled selected>Seleccionar...</option>
                </select>
                <div class="invalid-feedback d-none">Campo requerido</div>
            </div>

            <div class="form-group">
                <label class="form-label">Local</label>
                <select id="Locales" class="form-select" data-required="true">
                    <option value="" disabled selected>Seleccione UN...</option>
                </select>
                <div class="invalid-feedback d-none">Campo requerido</div>
            </div>

            <div class="form-group">
                <label class="form-label">Proveedor</label>
                <select id="Proveedores" class="form-select" data-required="true">
                    <option value="" disabled selected>Seleccionar...</option>
                </select>
                <div class="invalid-feedback d-none">Campo requerido</div>
            </div>

            <div class="form-group">
                <label class="form-label">Fecha Emisión</label>
                <input type="date" id="FechaEmision" class="form-control" data-required="true" />
                <div class="invalid-feedback d-none">Campo requerido</div>
            </div>

            <div class="form-group">
                <label class="form-label">Fecha Entrega</label>
                <input type="date" id="FechaEntrega" class="form-control" />
            </div>

            <div class="form-group">
                <label class="form-label">Estado</label>
                <select id="Estados" class="form-select" data-required="true">
                    <option value="" disabled selected>Seleccionar...</option>
                </select>
                <div class="invalid-feedback d-none">Campo requerido</div>
            </div>

            <div class="form-group full">
                <label class="form-label">Nota Interna</label>
                <input type="text" id="NotaInterna" class="form-control" />
            </div>

            <div class="form-group">
                <label class="form-label">Costo Total</label>
                <input type="text" id="CostoTotal" class="form-control" readonly />
            </div>
        </div>

        <!-- ALERTA GLOBAL CABECERA -->
        <div id="alertRequeridos" class="cc-alert-inline d-none mt-3">
            <i class="fa fa-exclamation-triangle"></i> Debes completar los campos requeridos.
        </div>
    </section>

    <!-- DETALLE -->
    <section class="cc-section cc-card mt-4">
        <div class="cc-titlebar">
            <h3 class="m-0"><i class="fa fa-cubes me-2"></i>Detalle de Insumos</h3>
            <div class="d-flex gap-2">
                <button type="button" id="btnAddDetalle" class="btn btn-new" onclick="abrirModalDetalle()">
                    <i class="fa fa-plus"></i> Añadir
                </button>
            </div>
        </div>

        <div class="cc-table">
            <table id="grd_Detalle" class="display nowrap w-100">
                <thead>
                    <tr>
                        <th>Insumo</th>
                        <th>Precio Unitario</th>
                        <th>Cantidad</th>
                        <th>SubTotal</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- ALERTA GLOBAL DETALLE -->
        <div id="alertDetalle" class="cc-alert-inline d-none mt-3">
            <i class="fa fa-exclamation-triangle"></i> Debes agregar al menos un insumo al detalle.
        </div>
    </section>

    <div class="d-flex justify-content-end gap-2 my-3">
        <button type="button" id="btnNuevoModificarOC" class="btn btn-new" onclick="guardarOC()">
            <i class="fa fa-save me-1"></i> Registrar
        </button>
    </div>
</main>

<!-- Modal Detalle -->
<div class="modal fade" id="detalleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content cc-modal cc-modal--elevated">
            <div class="modal-header cc-modal-header">
                <div class="d-flex align-items-center gap-2">
                    <span class="cc-badge"><i class="fa fa-cube"></i></span>
                    <h5 class="modal-title m-0 fw-bold" id="detalleModalTitle">Agregar Insumo</h5>
                </div>
                <button type="button" class="btn-close custom-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="formDetalle" class="cc-form-grid cc-form-2col">
                    <input type="hidden" id="detalleIndex" />

                    <div class="cc-field full">
                        <label class="form-label">Insumo</label>
                        <select id="InsumoSelect" class="form-select" data-required="true">
                            <option value="" disabled selected>Seleccionar un Insumo</option>
                        </select>
                        <div class="invalid-feedback d-none" data-msg-required="Campo requerido">Campo requerido</div>
                    </div>
                    <div class="cc-field">
                        <label class="form-label">Precio Unitario</label>
                        <input type="number" id="PrecioUnitario" class="form-control" data-required="true" data-min="0.0000001" step="0.0001" readonly />
                        <div class="invalid-feedback d-none" data-msg-required="Campo requerido" data-msg-min="Debe ser mayor que 0">Debe ser mayor que 0</div>
                    </div>
                    <div class="cc-field">
                        <label class="form-label">Cantidad</label>
                        <input type="number" id="Cantidad" class="form-control" data-required="true" data-min="0.0000001" step="0.0001" />
                        <div class="invalid-feedback d-none" data-msg-required="Campo requerido" data-msg-min="Debe ser mayor que 0">Debe ser mayor que 0</div>
                    </div>
                    <div class="cc-field full">
                        <label class="form-label">SubTotal</label>
                        <input type="text" id="SubTotal" class="form-control" readonly />
                    </div>
                    <div id="modalAlert" class="cc-alert-inline d-none" style="grid-column:1/-1">
                        <i class="fa fa-exclamation-triangle"></i> Debes completar los campos obligatorios.
                    </div>
                </form>
            </div>
            <div class="modal-footer cc-modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" id="btnGuardarDetalle" class="btn btn-new" onclick="guardarDetalle()">
                    <i class="fa fa-check"></i> Registrar
                </button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

    <!-- JS genérico validaciones (mismo que usa SubRecetas/Recetas) -->
    <script src="~/js/cc.validators.js?v=1.0"></script>

    <!-- Página -->
    <script src="~/js/OrdenesCompraNuevoModif.js"></script>
    <script src="~/js/site.js"></script>

    <script>
        var OrdenCompraData = @Html.Raw(Json.Serialize(ViewBag.Data ?? new { }));
    </script>
}
